#!/usr/bin/env bash
SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"
export
# Runtime not needed as part of buildpack, since it is included in lambda
# We use a node cli to deploy, it is installed in ./heroku directory.
# This prevents deployment since files are in use with in the dir being deployed.
# Therefore remove ./heroku directory
rm -rf $1/.heroku

# install nvm, npm, node 6.5.0 
echo "" && echo "Install Node ---- "
# install nvm
export NVM_DIR="$HOME/.nvm"
if [ ! -s "$NVM_DIR/nvm.sh" ]; then
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.0/install.sh | bash
fi 


if [ -s "$NVM_DIR/nvm.sh" ]; then
    source  "$NVM_DIR/nvm.sh"  # This loads nvm
fi    
echo $HOME
# install node v6.5.0 required by serverless
nvm install 6.5.0

# Use this version of node
nvm use 6.5.0

# make version 6.5.0 the default version
nvm alias default node

#Other shells may need node. So add nvm version of node and npm to /usr/local/bin


cat << EOF > "/usr/local/bin/node"
#!/bin/bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
node \$@
EOF
chmod +x /usr/local/bin/node
cat << EOF > "/usr/local/bin/npm"
#!/bin/bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
npm \$@ 
EOF
chmod +x /usr/local/bin/npm

#install serverless framework
echo "" && echo "Install Serverless npm package ---"
npm install -g serverless

# install deployer command line tool
echo "" && echo "install deployer cli tool"
pushd ${SCRIPTPATH}/../src/deployer && npm install 


# deploy app to lambda
echo "" && echo "Call deployer on the app directory"
node index.js --path $1 --runtime nodejs6.10